name: Build msd_lite for RK3568

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SDK_VERSION: "21.02.1"
      SDK_ARCH: "armvirt-64_gcc-8.4.0_musl"
      SDK_TAR: "openwrt-sdk-21.02.1-armvirt-64_gcc-8.4.0_musl.Linux-x86_64.tar.xz"
      SDK_DIR: "$GITHUB_WORKSPACE/openwrt-sdk/sdk"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential subversion git wget xz-utils ccache

      - name: Download OpenWrt SDK
        run: |
          wget https://downloads.openwrt.org/releases/${{ env.SDK_VERSION }}/targets/armvirt/64/${{ env.SDK_TAR }}
          tar -xJf ${{ env.SDK_TAR }} -C $GITHUB_WORKSPACE
          mv $GITHUB_WORKSPACE/openwrt-sdk-${{ env.SDK_VERSION }}-${{ env.SDK_ARCH }} $GITHUB_WORKSPACE/openwrt-sdk/sdk

      - name: Verify msd_lite directory
        run: |
          echo "Checking openwrt_msd_lite/msd_lite directory:"
          ls -l openwrt_msd_lite/msd_lite

      - name: Copy msd_lite package to SDK
        run: |
          cp -r openwrt_msd_lite/msd_lite $SDK_DIR/package/msd_lite

      - name: Update feeds
        run: |
          cd $SDK_DIR
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Compile msd_lite
        run: |
          cd $SDK_DIR
          make package/msd_lite/compile V=s -j$(nproc)

      - name: Upload msd_lite binary
        uses: actions/upload-artifact@v3
        with:
          name: msd_lite-bin
          path: $SDK_DIR/bin/packages/*/base/msd_lite*.ipk
