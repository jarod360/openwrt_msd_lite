name: Build MSD_Lite for RK3568

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug actual directory structure
        run: |
          echo "=== Root directory contents ==="
          ls -la
          echo "=== Searching for msd_lite related files ==="
          find . -name "*msd*" -type d 2>/dev/null || echo "No msd directories found"
          find . -name "Makefile" -type f | grep -i msd || echo "No msd Makefile found"
          echo "=== All directories ==="
          ls -la */

      - name: Set up environment
        run: |
          echo "SDK_URL=https://downloads.openwrt.org/releases/21.02.1/targets/armvirt/64/openwrt-sdk-21.02.1-armvirt-64_gcc-8.4.0_musl.Linux-x86_64.tar.xz" >> $GITHUB_ENV
          echo "SDK_DIR=openwrt-sdk/sdk" >> $GITHUB_ENV

      - name: Download and extract OpenWrt SDK
        run: |
          mkdir -p openwrt-sdk
          cd openwrt-sdk
          wget $SDK_URL
          SDK_TAR=$(basename $SDK_URL)
          tar -xf $SDK_TAR
          SDK_EXTRACTED_DIR=$(tar -tf $SDK_TAR | head -1 | cut -f1 -d"/")
          mv "$SDK_EXTRACTED_DIR" sdk
          cd ..

      - name: Find and copy msd_lite package
        run: |
          # 创建目标目录
          mkdir -p $SDK_DIR/package/
          
          # 尝试不同的可能路径
          if [ -d "openwrt_msd_lite/msd_lite" ]; then
            echo "Found: openwrt_msd_lite/msd_lite"
            cp -r openwrt_msd_lite/msd_lite $SDK_DIR/package/
          elif [ -d "msd_lite" ]; then
            echo "Found: msd_lite"
            cp -r msd_lite $SDK_DIR/package/
          elif [ -d "package/msd_lite" ]; then
            echo "Found: package/msd_lite"
            cp -r package/msd_lite $SDK_DIR/package/
          else
            echo "ERROR: Could not find msd_lite directory"
            echo "Available directories:"
            find . -maxdepth 2 -type d | sort
            exit 1
          fi
          
          echo "Successfully copied msd_lite package:"
          ls -la $SDK_DIR/package/msd_lite/

      - name: Build msd_lite
        run: |
          cd $SDK_DIR
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make package/msd_lite/{clean,compile} V=s

      - name: Upload compiled IPK package
        uses: actions/upload-artifact@v4
        with:
          name: msd_lite-ipk
          path: $SDK_DIR/bin/packages/aarch64_generic/base/msd_lite*.ipk

      - name: Upload compiled binary
        uses: actions/upload-artifact@v4
        with:
          name: msd_lite-binary
          path: $SDK_DIR/build_dir/target-*/msd_lite-*/msd_lite
