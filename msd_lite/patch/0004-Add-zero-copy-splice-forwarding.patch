From 0004d3e... Mon Sep 17 00:00:00 2025
From: msd-lite-patcher <patcher@example.com>
Date: 2025-11-19
Subject: [PATCH 0004/0007] Add zero-copy splice-based forwarding helper (with fallback)

--- a/src/forwarder.c
+++ b/src/forwarder.c
@@
+#include <fcntl.h>
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <unistd.h>
+#include <errno.h>
+#include <stdio.h>
+
+/* Forward data using splice: UDP socket -> pipe -> client socket.
+ * Returns 0 on success, -1 on error, 0 with errno==EAGAIN if non-blocking.
+ */
+int forward_splice_socket(int src_fd, int dst_fd, size_t bytes) {
+#ifdef SPLICE_F_MORE
+    int pipefd[2];
+    if (pipe(pipefd) < 0) {
+        perror("pipe");
+        return -1;
+    }
+
+    ssize_t s = splice(src_fd, NULL, pipefd[1], NULL, bytes, SPLICE_F_MORE | SPLICE_F_NONBLOCK);
+    if (s <= 0) {
+        close(pipefd[0]); close(pipefd[1]);
+        if (s == -1 && (errno == EAGAIN || errno == EWOULDBLOCK)) return 0;
+        return -1;
+    }
+
+    ssize_t w = splice(pipefd[0], NULL, dst_fd, NULL, s, SPLICE_F_MORE | SPLICE_F_NONBLOCK);
+    close(pipefd[0]); close(pipefd[1]);
+    if (w <= 0) {
+        if (w == -1 && (errno == EAGAIN || errno == EWOULDBLOCK)) return 0;
+        return -1;
+    }
+    return 0;
+#else
+    /* Fallback: read + write */
+    char buf[4096];
+    ssize_t r = read(src_fd, buf, sizeof(buf));
+    if (r > 0) {
+        ssize_t out = write(dst_fd, buf, r);
+        if (out < 0 && (errno == EAGAIN || errno == EWOULDBLOCK)) return 0;
+        return (out < 0) ? -1 : 0;
+    }
+    return (r == -1 && (errno == EAGAIN || errno == EWOULDBLOCK)) ? 0 : -1;
+#endif
+}
