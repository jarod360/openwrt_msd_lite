name: Build MSD_Lite for RK3568

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OpenWrt build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ccache \
            ecj \
            fastjar \
            file \
            g++ \
            gawk \
            gettext \
            git \
            java-propose-classpath \
            libelf-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libssl-dev \
            python3 \
            python3-dev \
            python3-pip \
            python3-setuptools \
            python3-venv \
            rsync \
            subversion \
            swig \
            time \
            xsltproc \
            zlib1g-dev \
            unzip

      - name: Set up Python alternatives
        run: |
          # 确保 python3 是默认的 python
          sudo update-alternatives --install /usr/bin/python python /usr/bin/python3 1
          python --version

      - name: Set up environment
        run: |
          echo "SDK_URL=https://downloads.openwrt.org/releases/21.02.1/targets/armvirt/64/openwrt-sdk-21.02.1-armvirt-64_gcc-8.4.0_musl.Linux-x86_64.tar.xz" >> $GITHUB_ENV
          echo "SDK_DIR=openwrt-sdk/sdk" >> $GITHUB_ENV

      - name: Download and extract OpenWrt SDK
        run: |
          mkdir -p openwrt-sdk
          cd openwrt-sdk
          wget -q $SDK_URL
          SDK_TAR=$(basename $SDK_URL)
          tar -xf $SDK_TAR
          SDK_EXTRACTED_DIR=$(tar -tf $SDK_TAR | head -1 | cut -f1 -d"/")
          mv "$SDK_EXTRACTED_DIR" sdk
          cd ..

      - name: Copy msd_lite package into SDK
        run: |
          mkdir -p $SDK_DIR/package/
          cp -r msd_lite $SDK_DIR/package/
          echo "Copied msd_lite package contents:"
          ls -la $SDK_DIR/package/msd_lite/

      - name: Build msd_lite with FORCE=1
        run: |
          cd $SDK_DIR
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          FORCE=1 make package/msd_lite/{clean,compile} V=s

      - name: Upload compiled IPK package
        uses: actions/upload-artifact@v4
        with:
          name: msd_lite-ipk
          path: $SDK_DIR/bin/packages/aarch64_generic/base/msd_lite*.ipk

      - name: Upload compiled binary
        uses: actions/upload-artifact@v4
        with:
          name: msd_lite-binary
          path: $SDK_DIR/build_dir/target-*/msd_lite-*/msd_lite
