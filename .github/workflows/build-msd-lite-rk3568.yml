name: Build MSD_Lite for RK3568

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          echo "SDK_URL=https://downloads.openwrt.org/releases/21.02.1/targets/armvirt/64/openwrt-sdk-21.02.1-armvirt-64_gcc-8.4.0_musl.Linux-x86_64.tar.xz" >> $GITHUB_ENV
          echo "SDK_DIR=openwrt-sdk/sdk" >> $GITHUB_ENV

      - name: Download and extract OpenWrt SDK
        run: |
          mkdir -p openwrt-sdk
          cd openwrt-sdk
          wget $SDK_URL
          SDK_TAR=$(basename $SDK_URL)
          tar -xf $SDK_TAR
          SDK_EXTRACTED_DIR=$(tar -tf $SDK_TAR | head -1 | cut -f1 -d"/")
          mv "$SDK_EXTRACTED_DIR" sdk
          cd ..

      - name: Verify source directory structure
        run: |
          echo "Checking openwrt_msd_lite/msd_lite directory:"
          ls -la openwrt_msd_lite/msd_lite/
          echo "Makefile exists:"
          ls -la openwrt_msd_lite/msd_lite/Makefile

      - name: Copy msd_lite package into SDK
        run: |
          # 确保目标目录存在
          mkdir -p $SDK_DIR/package/
          # 复制整个msd_lite包目录
          cp -r openwrt_msd_lite/msd_lite $SDK_DIR/package/
          # 验证复制是否成功
          echo "Copied contents:"
          ls -la $SDK_DIR/package/msd_lite/

      - name: Build msd_lite
        run: |
          cd $SDK_DIR
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make package/msd_lite/{clean,compile} V=s

      - name: Upload compiled IPK package
        uses: actions/upload-artifact@v4
        with:
          name: msd_lite-ipk
          path: $SDK_DIR/bin/packages/aarch64_generic/base/msd_lite*.ipk

      - name: Upload compiled binary
        uses: actions/upload-artifact@v4
        with:
          name: msd_lite-binary
          path: $SDK_DIR/build_dir/target-*/msd_lite-*/msd_lite
