name: æ„å»º MSD_Lite å’Œ LuCI åº”ç”¨ (RK3568)

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: true
        default: 'release'
        type: choice
        options:
        - prerelease
        - release
      ssh:
        description: 'å¯ç”¨ SSH è°ƒè¯•'
        required: false
        default: 'false'

# å·¥ä½œæµæƒé™é…ç½®
permissions:
  contents: write
  packages: read
  issues: read

env:
  TZ: Asia/Shanghai
  SDK_URL: https://downloads.openwrt.org/releases/23.05.3/targets/rockchip/armv8/openwrt-sdk-23.05.3-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz

jobs:
  build:
    name: æ„å»º msd_lite å’Œ LuCI åº”ç”¨
    runs-on: ubuntu-latest
    
    # ä»»åŠ¡çº§åˆ«æƒé™è®¾ç½®
    permissions:
      contents: write
      packages: read
    
    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4

      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install \
            build-essential \
            ccache \
            file \
            g++ \
            gawk \
            gettext \
            git \
            libncurses5-dev \
            libncursesw5-dev \
            libssl-dev \
            python3 \
            python3-pip \
            python3-setuptools \
            rsync \
            unzip \
            wget \
            zlib1g-dev \
            zstd

      - name: ä¸‹è½½å¹¶è§£å‹ OpenWrt SDK
        run: |
          echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ OpenWrt SDK..."
          wget -q ${{ env.SDK_URL }}
          file_name=$(echo ${{ env.SDK_URL }} | awk -F/ '{print $NF}')
          mkdir sdk
          if [[ $file_name == *.tar.xz ]]; then
            tar -xJf $file_name -C ./sdk --strip-components=1
          elif [[ $file_name == *.tar.zst ]]; then
            tar --zstd -x -f $file_name -C ./sdk --strip-components=1
          else
            echo "âŒ ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: $file_name"
            exit 1
          fi
          echo "âœ… SDK ä¸‹è½½è§£å‹å®Œæˆ"
          echo "SDK_DIR=$PWD/sdk" >> $GITHUB_ENV

      - name: å¤åˆ¶è½¯ä»¶åŒ…åˆ° SDK
        run: |
          # å¤åˆ¶ msd_lite åŒ…
          if [ -d "msd_lite" ]; then
            cp -r msd_lite $SDK_DIR/package/
            echo "âœ… msd_lite è½¯ä»¶åŒ…å¤åˆ¶æˆåŠŸ"
          else
            echo "âŒ æ‰¾ä¸åˆ° msd_lite è½¯ä»¶åŒ…ç›®å½•"
            find . -name "*msd*" -type d
            exit 1
          fi
          
          # å¤åˆ¶ luci-app-msd_lite åŒ…
          if [ -d "luci-app-msd_lite" ]; then
            cp -r luci-app-msd_lite $SDK_DIR/package/
            echo "âœ… luci-app-msd_lite è½¯ä»¶åŒ…å¤åˆ¶æˆåŠŸ"
          else
            echo "âŒ æ‰¾ä¸åˆ° luci-app-msd_lite è½¯ä»¶åŒ…ç›®å½•"
            exit 1
          fi
          
          echo "ğŸ“ è½¯ä»¶åŒ…å†…å®¹:"
          ls -la $SDK_DIR/package/msd_lite/
          ls -la $SDK_DIR/package/luci-app-msd_lite/

      - name: SSH è¿æ¥è°ƒè¯•
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event.inputs.ssh == 'true' }}

      - name: é…ç½® feeds å’Œç¼–è¯‘è®¾ç½®
        run: |
          cd $SDK_DIR
          
          # æ›´æ–° feeds
          echo "ğŸ”„ æ›´æ–° feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # åŸºç¡€é…ç½® - åŒæ—¶å¯ç”¨ä¸¤ä¸ªåŒ…
          echo "âš™ï¸ é…ç½®ç¼–è¯‘å‚æ•°..."
          echo "CONFIG_TARGET_rockchip_armv8=y" > .config
          echo "CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r5s=y" >> .config
          echo "CONFIG_ALL_NONSHARED=n" >> .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_AUTOREMOVE=y" >> .config
          echo "CONFIG_PACKAGE_msd_lite=m" >> .config
          echo "CONFIG_PACKAGE_luci-app-msd_lite=m" >> .config
          
          make defconfig
          echo "âœ… é…ç½®å®Œæˆ"

      - name: ä¸‹è½½è½¯ä»¶åŒ…æºç 
        run: |
          cd $SDK_DIR
          echo "ğŸ“¥ ä¸‹è½½è½¯ä»¶åŒ…æºç ..."
          make package/msd_lite/download V=s
          make package/luci-app-msd_lite/download V=s
          find dl -size -1024c -exec ls -l {} \; || true

      - name: ç¼–è¯‘è½¯ä»¶åŒ…
        id: compile
        run: |
          cd $SDK_DIR
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘è½¯ä»¶åŒ…..."
          
          # æ¸…ç†å¹¶ç¼–è¯‘ msd_lite
          echo "ğŸ”§ ç¼–è¯‘ msd_lite..."
          make package/msd_lite/clean V=s
          make package/msd_lite/compile -j$(nproc) V=s
          
          # æ¸…ç†å¹¶ç¼–è¯‘ luci-app-msd_lite
          echo "ğŸ”§ ç¼–è¯‘ luci-app-msd_lite..."
          make package/luci-app-msd_lite/clean V=s
          make package/luci-app-msd_lite/compile -j$(nproc) V=s
          
          echo "âœ… ç¼–è¯‘å®Œæˆ"
          echo "status=success" >> $GITHUB_OUTPUT
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: æ•´ç†ç¼–è¯‘äº§ç‰©
        if: steps.compile.outputs.status == 'success'
        run: |
          cd $SDK_DIR
          echo "ğŸ“¦ æ­£åœ¨æ•´ç†ç¼–è¯‘äº§ç‰©..."
          
          # åˆ›å»ºä¸Šä¼ ç›®å½•
          mkdir -p upload
          
          # æŸ¥æ‰¾æ‰€æœ‰ IPK æ–‡ä»¶
          echo "=== IPK æ–‡ä»¶ ==="
          find bin -name "*msd_lite*.ipk" -type f | while read file; do
            echo "æ‰¾åˆ° IPK æ–‡ä»¶: $file"
            cp "$file" upload/
          done
          
          # æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶
          echo "=== äºŒè¿›åˆ¶æ–‡ä»¶ ==="
          find build_dir -name "msd_lite" -type f | while read file; do
            if file "$file" | grep -q "ELF"; then
              echo "æ‰¾åˆ° ELF äºŒè¿›åˆ¶æ–‡ä»¶: $file"
              cp "$file" upload/msd_lite
              chmod +x upload/msd_lite
              break
            fi
          done
          
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæœç´¢ç¼–è¯‘ç›®å½•
          if [ ! -f "upload/msd_lite" ]; then
            echo "âš ï¸  åœ¨ç¼–è¯‘ç›®å½•ä¸­æœç´¢..."
            find build_dir -path "*/msd_lite-*" -name "msd_lite" -type f | head -5 | while read file; do
              echo "åœ¨ç¼–è¯‘ç›®å½•ä¸­æ‰¾åˆ°: $file"
              cp "$file" upload/msd_lite
              chmod +x upload/msd_lite
              break
            done
          fi
          
          echo "ğŸ“ ä¸Šä¼ ç›®å½•å†…å®¹:"
          ls -la upload/
          echo "ğŸ“Š æ–‡ä»¶è¯¦ç»†ä¿¡æ¯:"
          file upload/* 2>/dev/null || echo "ä¸Šä¼ ç›®å½•ä¸­æ²¡æœ‰æ–‡ä»¶"

      - name: ç”Ÿæˆå‘å¸ƒä¿¡æ¯
        id: info
        if: steps.compile.outputs.status == 'success'
        run: |
          cd $SDK_DIR
          echo "## ğŸ¯ MSD_Lite for RK3568" > upload/RELEASE_INFO.md
          echo "![](https://img.shields.io/github/downloads/${{ github.repository }}/total?style=flat-square)" >> upload/RELEASE_INFO.md
          echo "### ğŸ“‹ ç¼–è¯‘ä¿¡æ¯" >> upload/RELEASE_INFO.md
          echo "**ğŸ“… ç¼–è¯‘æ—¥æœŸ:** $(date)" >> upload/RELEASE_INFO.md
          echo "**ğŸ’» å¹³å°:** RK3568 (Rockchip ARMv8)" >> upload/RELEASE_INFO.md
          echo "**ğŸ”§ SDK ç‰ˆæœ¬:** OpenWrt 23.05.3" >> upload/RELEASE_INFO.md
          echo "**ğŸ”– Commit:** ${{ github.sha }}" >> upload/RELEASE_INFO.md
          
          echo "### ğŸ“¦ åŒ…å«çš„è½¯ä»¶åŒ…" >> upload/RELEASE_INFO.md
          echo "- **msd_lite** - è½»é‡çº§ç»„æ’­æµå®ˆæŠ¤è¿›ç¨‹" >> upload/RELEASE_INFO.md
          echo "- **luci-app-msd_lite** - LuCI ç½‘é¡µç®¡ç†ç•Œé¢" >> upload/RELEASE_INFO.md
          
          echo "### ğŸ“– å®‰è£…è¯´æ˜" >> upload/RELEASE_INFO.md
          echo "1. å°† IPK æ–‡ä»¶ä¸Šä¼ åˆ° OpenWrt è®¾å¤‡" >> upload/RELEASE_INFO.md
          echo "2. å®‰è£…ä¸»ç¨‹åº: \`opkg install msd_lite_*.ipk\`" >> upload/RELEASE_INFO.md
          echo "3. å®‰è£… LuCI ç•Œé¢: \`opkg install luci-app-msd_lite_*.ipk\`" >> upload/RELEASE_INFO.md
          echo "4. åœ¨ LuCI ä¸­è®¿é—®: æœåŠ¡ â†’ MSD Lite" >> upload/RELEASE_INFO.md
          
          echo "### ğŸ“ æ–‡ä»¶åˆ—è¡¨" >> upload/RELEASE_INFO.md
          echo "\`\`\`" >> upload/RELEASE_INFO.md
          ls -la upload/ >> upload/RELEASE_INFO.md
          echo "\`\`\`" >> upload/RELEASE_INFO.md
          
          echo "status=success" >> $GITHUB_OUTPUT

      - name: è°ƒè¯•æƒé™å’Œæ–‡ä»¶
        if: steps.compile.outputs.status == 'success'
        run: |
          cd $SDK_DIR
          echo "ğŸ”§ æ£€æŸ¥æƒé™å’Œæ–‡ä»¶..."
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "ä¸Šä¼ ç›®å½•å†…å®¹:"
          ls -la upload/
          echo "å‘å¸ƒä¿¡æ¯æ–‡ä»¶:"
          cat upload/RELEASE_INFO.md || echo "æ²¡æœ‰å‘å¸ƒä¿¡æ¯æ–‡ä»¶"

      - name: åˆ›å»º GitHub å‘å¸ƒ
        if: steps.compile.outputs.status == 'success' && steps.info.outputs.status == 'success'
        run: |
          BUILD_TAG="build-$(date +%Y%m%d-%H%M%S)"
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          
          echo "åˆ›å»ºå‘å¸ƒ: $BUILD_TAG"
          echo "å‘å¸ƒç±»å‹: $RELEASE_TYPE"
          
          if [ "$RELEASE_TYPE" = "prerelease" ]; then
            gh release create "$BUILD_TAG" \
              --title "MSD Lite RK3568 ç¼–è¯‘ç‰ˆæœ¬ $(date +'%Y-%m-%d %H:%M')" \
              --notes-file ${{ env.SDK_DIR }}/upload/RELEASE_INFO.md \
              ${{ env.SDK_DIR }}/upload/*.ipk \
              ${{ env.SDK_DIR }}/upload/msd_lite \
              --prerelease
          else
            gh release create "$BUILD_TAG" \
              --title "MSD Lite RK3568 æ­£å¼ç‰ˆæœ¬ $(date +'%Y-%m-%d %H:%M')" \
              --notes-file ${{ env.SDK_DIR }}/upload/RELEASE_INFO.md \
              ${{ env.SDK_DIR }}/upload/*.ipk \
              ${{ env.SDK_DIR }}/upload/msd_lite
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼  IPK åŒ…åˆ°äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: msd-lite-ipk-packages
          path: ${{ env.SDK_DIR }}/upload/*.ipk
          if-no-files-found: warn

      - name: ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶åˆ°äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: msd-lite-binary
          path: ${{ env.SDK_DIR }}/upload/msd_lite
          if-no-files-found: warn

      - name: è°ƒè¯•ç¼–è¯‘ç›®å½•ç»“æ„
        if: always()
        run: |
          cd $SDK_DIR
          echo "ğŸ” è°ƒè¯•ç¼–è¯‘ç›®å½•ç»“æ„..."
          echo "=== æ‰€æœ‰ IPK æ–‡ä»¶ ==="
          find bin -name "*.ipk" -type f | head -20
          echo "=== ç¼–è¯‘ç›®å½• ==="
          find build_dir -name "*msd_lite*" -type d | head -10
