name: Build MSD_Lite for RK3568

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  TZ: Asia/Shanghai
  SDK_URL: https://downloads.openwrt.org/releases/23.05.3/targets/rockchip/armv8/openwrt-sdk-23.05.3-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz

jobs:
  build:
    name: Build msd_lite for RK3568
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install \
            build-essential \
            ccache \
            file \
            g++ \
            gawk \
            gettext \
            git \
            libncurses5-dev \
            libncursesw5-dev \
            libssl-dev \
            python3 \
            python3-pip \
            python3-setuptools \
            rsync \
            unzip \
            wget \
            zlib1g-dev \
            zstd

      - name: Download and extract OpenWrt SDK
        run: |
          wget -q ${{ env.SDK_URL }}
          file_name=$(echo ${{ env.SDK_URL }} | awk -F/ '{print $NF}')
          mkdir sdk
          if [[ $file_name == *.tar.xz ]]; then
            tar -xJf $file_name -C ./sdk --strip-components=1
          elif [[ $file_name == *.tar.zst ]]; then
            tar --zstd -x -f $file_name -C ./sdk --strip-components=1
          else
            echo "Unsupported file format: $file_name"
            exit 1
          fi
          echo "SDK_DIR=$PWD/sdk" >> $GITHUB_ENV

      - name: Copy msd_lite package to SDK
        run: |
          # æ£€æŸ¥å¹¶å¤åˆ¶ msd_lite åŒ…
          if [ -d "msd_lite" ]; then
            cp -r msd_lite $SDK_DIR/package/
            echo "âœ… msd_lite package copied successfully"
          elif [ -d "openwrt_msd_lite/msd_lite" ]; then
            cp -r openwrt_msd_lite/msd_lite $SDK_DIR/package/
            echo "âœ… msd_lite package copied from openwrt_msd_lite directory"
          else
            echo "âŒ Could not find msd_lite package directory"
            find . -name "*msd*" -type d
            exit 1
          fi
          
          echo "Package contents:"
          ls -la $SDK_DIR/package/msd_lite/

      - name: SSH connection to Actions (debug)
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event.inputs.ssh == 'true' }}

      - name: Setup feeds and configuration
        run: |
          cd $SDK_DIR
          
          # æ›´æ–° feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # åŸºç¡€é…ç½®
          echo "CONFIG_TARGET_rockchip_armv8=y" > .config
          echo "CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r5s=y" >> .config
          echo "CONFIG_ALL_NONSHARED=n" >> .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_AUTOREMOVE=y" >> .config
          echo "CONFIG_PACKAGE_msd_lite=m" >> .config
          
          make defconfig

      - name: Download package sources
        run: |
          cd $SDK_DIR
          make package/msd_lite/download V=s
          find dl -size -1024c -exec ls -l {} \; || true

      - name: Build msd_lite package
        id: compile
        run: |
          cd $SDK_DIR
          echo "ðŸš€ Starting msd_lite compilation..."
          
          # æ¸…ç†å¹¶ç¼–è¯‘
          make package/msd_lite/clean V=s
          make package/msd_lite/compile -j$(nproc) V=s
          
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Check build results
        if: steps.compile.outputs.status == 'success'
        run: |
          cd $SDK_DIR
          echo "ðŸ“¦ Build results:"
          echo "=== IPK files ==="
          find bin -name "msd_lite*.ipk" -type f | head -10 || echo "No IPK files found"
          echo "=== Binary files ==="
          find build_dir -name "msd_lite" -type f -executable | head -5 || echo "No binary files found"
          
          # åˆ›å»ºä¸Šä¼ ç›®å½•
          mkdir -p upload
          cp bin/packages/aarch64_generic/base/msd_lite*.ipk upload/ 2>/dev/null || true
          cp build_dir/target-*/msd_lite-*/msd_lite upload/ 2>/dev/null || true
          
          echo "Upload directory contents:"
          ls -la upload/

      - name: Upload IPK package artifact
        uses: actions/upload-artifact@v4
        with:
          name: msd_lite-ipk-rk3568
          path: ${{ env.SDK_DIR }}/upload/*.ipk
          if-no-files-found: warn

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: msd_lite-binary-rk3568
          path: ${{ env.SDK_DIR }}/upload/msd_lite
          if-no-files-found: warn

      - name: Create release info
        if: steps.compile.outputs.status == 'success'
        run: |
          cd $SDK_DIR
          cat > release_info.md << EOF
          # MSD_Lite for RK3568
          
          ## Build Information
          - **Platform**: RK3568 (Rockchip ARMv8)
          - **SDK Version**: OpenWrt 23.05.3
          - **Build Date**: $(date +"%Y-%m-%d %H:%M:%S")
          - **Repository**: ${{ github.repository }}
          - **Commit**: ${{ github.sha }}
          
          ## Package Contents
          $(ls -la upload/ || echo "No files found")
          EOF
          
          cat release_info.md

      - name: Upload build logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            ${{ env.SDK_DIR }}/logs/
            ${{ env.SDK_DIR }}/build_dir/target-*/msd_lite-*/config.log
