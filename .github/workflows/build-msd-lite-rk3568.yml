name: Build MSD_Lite and LuCI App for RK3568

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

# Ê∑ªÂä†Â∑•‰ΩúÊµÅÁ∫ßÂà´ÁöÑÊùÉÈôêÈÖçÁΩÆ
permissions:
  contents: write  # ËøôË°åÊòØÂÖ≥ÈîÆÔºÅ
  packages: read
  issues: read

env:
  TZ: Asia/Shanghai
  SDK_URL: https://downloads.openwrt.org/releases/23.05.3/targets/rockchip/armv8/openwrt-sdk-23.05.3-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz

jobs:
  build:
    name: Build msd_lite and LuCI app for RK3568
    runs-on: ubuntu-latest
    
    # ‰πüÂèØ‰ª•Âú® job Á∫ßÂà´ËÆæÁΩÆÊùÉÈôêÔºàÂèåÈáç‰øùÈöúÔºâ
    permissions:
      contents: write
      packages: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install \
            build-essential \
            ccache \
            file \
            g++ \
            gawk \
            gettext \
            git \
            libncurses5-dev \
            libncursesw5-dev \
            libssl-dev \
            python3 \
            python3-pip \
            python3-setuptools \
            rsync \
            unzip \
            wget \
            zlib1g-dev \
            zstd

      - name: Download and extract OpenWrt SDK
        run: |
          wget -q ${{ env.SDK_URL }}
          file_name=$(echo ${{ env.SDK_URL }} | awk -F/ '{print $NF}')
          mkdir sdk
          if [[ $file_name == *.tar.xz ]]; then
            tar -xJf $file_name -C ./sdk --strip-components=1
          elif [[ $file_name == *.tar.zst ]]; then
            tar --zstd -x -f $file_name -C ./sdk --strip-components=1
          else
            echo "Unsupported file format: $file_name"
            exit 1
          fi
          echo "SDK_DIR=$PWD/sdk" >> $GITHUB_ENV

      - name: Copy packages to SDK
        run: |
          # Â§çÂà∂ msd_lite ÂåÖ
          if [ -d "msd_lite" ]; then
            cp -r msd_lite $SDK_DIR/package/
            echo "‚úÖ msd_lite package copied successfully"
          else
            echo "‚ùå Could not find msd_lite package directory"
            find . -name "*msd*" -type d
            exit 1
          fi
          
          # Â§çÂà∂ luci-app-msd_lite ÂåÖ
          if [ -d "luci-app-msd_lite" ]; then
            cp -r luci-app-msd_lite $SDK_DIR/package/
            echo "‚úÖ luci-app-msd_lite package copied successfully"
          else
            echo "‚ùå Could not find luci-app-msd_lite package directory"
            exit 1
          fi
          
          echo "Package contents:"
          ls -la $SDK_DIR/package/msd_lite/
          ls -la $SDK_DIR/package/luci-app-msd_lite/

      - name: SSH connection to Actions (debug)
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event.inputs.ssh == 'true' }}

      - name: Setup feeds and configuration
        run: |
          cd $SDK_DIR
          
          # Êõ¥Êñ∞ feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # Âü∫Á°ÄÈÖçÁΩÆ - ÂêåÊó∂ÂêØÁî®‰∏§‰∏™ÂåÖ
          echo "CONFIG_TARGET_rockchip_armv8=y" > .config
          echo "CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r5s=y" >> .config
          echo "CONFIG_ALL_NONSHARED=n" >> .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_AUTOREMOVE=y" >> .config
          echo "CONFIG_PACKAGE_msd_lite=m" >> .config
          echo "CONFIG_PACKAGE_luci-app-msd_lite=m" >> .config
          
          make defconfig

      - name: Download package sources
        run: |
          cd $SDK_DIR
          make package/msd_lite/download V=s
          make package/luci-app-msd_lite/download V=s
          find dl -size -1024c -exec ls -l {} \; || true

      - name: Build both packages
        id: compile
        run: |
          cd $SDK_DIR
          echo "üöÄ Starting compilation of both packages..."
          
          # Ê∏ÖÁêÜÂπ∂ÁºñËØë msd_lite
          make package/msd_lite/clean V=s
          make package/msd_lite/compile -j$(nproc) V=s
          
          # Ê∏ÖÁêÜÂπ∂ÁºñËØë luci-app-msd_lite
          make package/luci-app-msd_lite/clean V=s
          make package/luci-app-msd_lite/compile -j$(nproc) V=s
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: Find and organize build artifacts
        if: steps.compile.outputs.status == 'success'
        run: |
          cd $SDK_DIR
          echo "üì¶ Searching for build artifacts..."
          
          # ÂàõÂª∫‰∏ä‰º†ÁõÆÂΩï
          mkdir -p upload
          
          # Êü•ÊâæÊâÄÊúâ IPK Êñá‰ª∂
          echo "=== IPK files ==="
          find bin -name "*msd_lite*.ipk" -type f | while read file; do
            echo "Found IPK: $file"
            cp "$file" upload/
          done
          
          # Êü•Êâæ‰∫åËøõÂà∂Êñá‰ª∂
          echo "=== Binary files ==="
          find build_dir -name "msd_lite" -type f | while read file; do
            if file "$file" | grep -q "ELF"; then
              echo "Found ELF binary: $file"
              cp "$file" upload/msd_lite
              chmod +x upload/msd_lite
              break
            fi
          done
          
          # Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞‰∫åËøõÂà∂Êñá‰ª∂ÔºåÊêúÁ¥¢ÁºñËØëÁõÆÂΩï
          if [ ! -f "upload/msd_lite" ]; then
            echo "‚ö†Ô∏è  Searching in build directories..."
            find build_dir -path "*/msd_lite-*" -name "msd_lite" -type f | head -5 | while read file; do
              echo "Found in build dir: $file"
              cp "$file" upload/msd_lite
              chmod +x upload/msd_lite
              break
            done
          fi
          
          echo "üìÅ Upload directory contents:"
          ls -la upload/
          echo "üìä File details:"
          file upload/* 2>/dev/null || echo "No files in upload directory"

      - name: Generate release info
        id: info
        if: steps.compile.outputs.status == 'success'
        run: |
          cd $SDK_DIR
          echo "## :mega: MSD_Lite for RK3568" > upload/RELEASE_INFO.md
          echo "![](https://img.shields.io/github/downloads/${{ github.repository }}/total?style=flat-square)" >> upload/RELEASE_INFO.md
          echo "### Build Information" >> upload/RELEASE_INFO.md
          echo "**:minidisc: Build Date:** $(date)" >> upload/RELEASE_INFO.md
          echo "**:computer: Platform:** RK3568 (Rockchip ARMv8)" >> upload/RELEASE_INFO.md
          echo "**:gear: SDK Version:** OpenWrt 23.05.3" >> upload/RELEASE_INFO.md
          echo "**:hash: Commit:** ${{ github.sha }}" >> upload/RELEASE_INFO.md
          
          echo "### Packages Included" >> upload/RELEASE_INFO.md
          echo "- **msd_lite** - Multicast Stream Daemon Lite" >> upload/RELEASE_INFO.md
          echo "- **luci-app-msd_lite** - LuCI Web Interface" >> upload/RELEASE_INFO.md
          
          echo "### Installation Instructions" >> upload/RELEASE_INFO.md
          echo "1. Upload IPK files to your OpenWrt device" >> upload/RELEASE_INFO.md
          echo "2. Install: \`opkg install msd_lite_*.ipk\`" >> upload/RELEASE_INFO.md
          echo "3. Install LuCI: \`opkg install luci-app-msd_lite_*.ipk\`" >> upload/RELEASE_INFO.md
          echo "4. Access via LuCI: Services ‚Üí MSD Lite" >> upload/RELEASE_INFO.md
          
          echo "### File List" >> upload/RELEASE_INFO.md
          echo "\`\`\`" >> upload/RELEASE_INFO.md
          ls -la upload/ >> upload/RELEASE_INFO.md
          echo "\`\`\`" >> upload/RELEASE_INFO.md
          
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Debug permissions and files
        if: steps.compile.outputs.status == 'success'
        run: |
          cd $SDK_DIR
          echo "üîß Checking permissions and files..."
          echo "Working directory: $(pwd)"
          echo "Upload directory contents:"
          ls -la upload/
          echo "Release info file:"
          cat upload/RELEASE_INFO.md || echo "No release info file"

      - name: Create GitHub Release
        if: steps.compile.outputs.status == 'success' && steps.info.outputs.status == 'success'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "build-$(date +%Y%m%d-%H%M%S)"
          name: "MSD Lite RK3568 Build $(date +'%Y-%m-%d %H:%M')"
          body_path: ${{ env.SDK_DIR }}/upload/RELEASE_INFO.md
          files: |
            ${{ env.SDK_DIR }}/upload/*.ipk
            ${{ env.SDK_DIR }}/upload/msd_lite
          prerelease: true
          draft: false

      - name: Upload IPK packages to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: msd-lite-ipk-packages
          path: ${{ env.SDK_DIR }}/upload/*.ipk
          if-no-files-found: warn

      - name: Upload binary to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: msd-lite-binary
          path: ${{ env.SDK_DIR }}/upload/msd_lite
          if-no-files-found: warn

      - name: Debug build directory structure
        if: always()
        run: |
          cd $SDK_DIR
          echo "üîç Debugging build directory structure..."
          echo "=== All IPK files ==="
          find bin -name "*.ipk" -type f | head -20
          echo "=== Build directories ==="
          find build_dir -name "*msd_lite*" -type d | head -10
