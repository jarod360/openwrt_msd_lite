name: Build MSD_Lite for RK3568

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OpenWrt SDK
        run: |
          mkdir -p openwrt-sdk
          cd openwrt-sdk
          wget -q https://downloads.openwrt.org/releases/21.02.1/targets/armvirt/64/openwrt-sdk-21.02.1-armvirt-64_gcc-8.4.0_musl.Linux-x86_64.tar.xz
          tar -xf openwrt-sdk-21.02.1-armvirt-64_gcc-8.4.0_musl.Linux-x86_64.tar.xz
          mv openwrt-sdk-21.02.1-armvirt-64_gcc-8.4.0_musl.Linux-x86_64 sdk
          cd ..

      - name: Copy msd_lite package
        run: |
          cp -r msd_lite openwrt-sdk/sdk/package/
          echo "Package copied successfully:"
          ls -la openwrt-sdk/sdk/package/msd_lite/

      - name: Build using Docker
        run: |
          # 使用 OpenWrt 官方 Docker 镜像构建
          docker run --rm \
            -v $(pwd)/openwrt-sdk/sdk:/sdk \
            -v $(pwd)/msd_lite:/msd_lite \
            openwrtorg/sdk:armvirt-64-21.02.1 \
            /bin/bash -c "
              cd /sdk
              cp -r /msd_lite package/
              ./scripts/feeds update -a
              ./scripts/feeds install -a
              make package/msd_lite/clean
              make package/msd_lite/compile V=s
            "

      - name: Upload IPK package
        uses: actions/upload-artifact@v4
        with:
          name: msd_lite-ipk-package
          path: openwrt-sdk/sdk/bin/packages/aarch64_generic/base/msd_lite*.ipk

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: msd_lite-binary
          path: openwrt-sdk/sdk/build_dir/target-*/msd_lite-*/msd_lite
